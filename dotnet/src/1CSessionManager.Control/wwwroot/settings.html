<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 40px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; max-width: 880px; margin-bottom: 16px; }
    label { display:block; margin-top: 10px; font-size: 13px; color:#374151; }
    input, select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 8px; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; background:#2563eb; color:#fff; cursor:pointer; }
    button.secondary { background:#6b7280; }
    code { background:#f3f4f6; padding: 2px 6px; border-radius: 6px; }
    .muted { color:#6b7280; font-size: 13px; }
    .ok { color: #16a34a; }
    .err { color: #dc2626; }
  </style>
</head>
<body>
  <a href="/">&larr; –Ω–∞–∑–∞–¥</a>

  <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
  <p class="muted">–°–µ–∫—Ä–µ—Ç—ã –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö. –ü–∞—Ä–æ–ª–∏ –∑–∞–¥–∞—é—Ç—Å—è –∑–¥–µ—Å—å –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î –≤ –∑–∞—â–∏—â—ë–Ω–Ω–æ–º –≤–∏–¥–µ.</p>

  <div class="card">
    <h3>MSSQL (SQL login)</h3>
    <p class="muted">–ü–∞—Ä–æ–ª—å MSSQL —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ <b>Windows Credential Manager</b> (–Ω–µ –≤ —Ñ–∞–π–ª–∞—Ö). –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å localhost.</p>
    <div id="sqlStatus" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div class="row" style="margin-top:10px">
      <div style="flex:1; min-width: 260px;">
        <label>SQL user</label>
        <input id="sqlUser" placeholder="sql_user" />
      </div>
      <div style="flex:1; min-width: 260px;">
        <label>SQL password</label>
        <input id="sqlPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
    </div>
    <div style="margin-top: 12px" class="row">
      <button onclick="saveSqlLogin()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å SQL login</button>
      <button class="secondary" onclick="loadSqlStatus()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
    </div>
    <div id="sqlMsg" class="muted"></div>
  </div>

  <div class="card">
    <h3>API Key (–∑–∞—â–∏—Ç–∞ Control API)</h3>
    <p class="muted">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤: <code>X-Api-Key</code>. –ï—Å–ª–∏ –∫–ª—é—á –µ—â—ë –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –µ–≥–æ –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å localhost.</p>
    <label>–¢–µ–∫—É—â–∏–π API key</label>
    <div id="apiKeyStatus" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <label>–ù–æ–≤—ã–π API key (–º–∏–Ω–∏–º—É–º 16 —Å–∏–º–≤–æ–ª–æ–≤)</label>
    <input id="apiKeyInput" type="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á" />
    <div style="margin-top: 10px" class="row">
      <button onclick="setApiKey()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å API key</button>
      <button class="secondary" onclick="loadApiKeyStatus()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
    </div>
    <div id="apiKeyMsg" class="muted"></div>
  </div>

  <div class="card">
    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≥–µ–Ω—Ç–∞</h3>
    <label>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≥–µ–Ω—Ç</label>
    <select id="agentSelect" onchange="loadAgentSettings()"></select>
    <div id="agentMsg" class="muted"></div>

    <div style="margin-top: 10px" class="row">
      <div style="flex:1; min-width: 260px;">
        <label>–í–µ—Ä—Å–∏—è 1–° –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
        <select id="defaultVersion" onchange="onVersionChange()"></select>
      </div>
      <div style="flex:1; min-width: 260px;">
        <label>RAC path</label>
        <input id="racPath" placeholder="C:\\Program Files\\1cv8\\...\\rac.exe" />
      </div>
      <div style="flex:1; min-width: 260px;">
        <label>RAS host</label>
        <input id="rasHost" placeholder="localhost:1545" />
      </div>
    </div>

    <div style="margin-top: 10px" class="row">
      <div style="flex:1; min-width: 260px;">
        <label>Cluster user</label>
        <input id="clusterUser" placeholder="(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" />
      </div>
      <div style="flex:1; min-width: 260px;">
        <label>Cluster password (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è; –≤–≤–æ–¥ = –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å)</label>
        <input id="clusterPass" type="password" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å" />
        <div id="clusterPassSet" class="muted"></div>
      </div>
    </div>

    <div style="margin-top: 10px" class="row">
      <div style="flex:1; min-width: 260px;">
        <label>Poll interval (—Å–µ–∫)</label>
        <input id="pollInterval" type="number" min="5" max="3600" />
      </div>
      <div style="flex:1; min-width: 260px;">
        <label>Kill mode</label>
        <select id="killMode">
          <option value="true">–í–∫–ª—é—á–µ–Ω</option>
          <option value="false">–í—ã–∫–ª—é—á–µ–Ω</option>
        </select>
      </div>
      <div style="flex:1; min-width: 260px;">
        <label>Agent enabled</label>
        <select id="agentEnabled">
          <option value="true">–í–∫–ª—é—á–µ–Ω</option>
          <option value="false">–í—ã–∫–ª—é—á–µ–Ω</option>
        </select>
      </div>
    </div>

    <div style="margin-top: 12px" class="row">
      <button onclick="saveAgentSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≥–µ–Ω—Ç–∞</button>
      <button class="secondary" onclick="loadAgentSettings()">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </div>

  <div class="card">
    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏—è–º–∏</h3>
    <p class="muted">–°–ø–∏—Å–æ–∫ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –±–∞–∑ –Ω–∞ IIS (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≥–µ–Ω—Ç–æ–º —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É).</p>
    
    <div style="margin-bottom: 12px" class="row">
        <button onclick="showPublishModal()" class="secondary">‚ûï –ù–æ–≤–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è</button>
        <button onclick="showMassUpdateModal()" class="secondary">üîÑ –ú–∞—Å—Å–æ–≤–∞—è —Å–º–µ–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</button>
    </div>

    <table width="100%" style="border-collapse: collapse; font-size: 14px;">
        <thead>
            <tr style="text-align: left; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                <th style="padding: 8px;">–°–∞–π—Ç</th>
                <th style="padding: 8px;">–ü—É—Ç—å (App)</th>
                <th style="padding: 8px;">–§–∏–∑–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å</th>
                <th style="padding: 8px;">–í–µ—Ä—Å–∏—è</th>
                <th style="padding: 8px;">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="pubsTable"></tbody>
    </table>
  </div>

  <!-- Modal: Publish -->
  <dialog id="publishModal" style="border: 1px solid #ccc; border-radius: 8px; padding: 20px; max-width: 500px;">
    <h3>–ù–æ–≤–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è</h3>
    <label>–ò–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (URL path)</label>
    <input id="pubName" placeholder="buh_demo" />
    
    <label>–ò–º—è –±–∞–∑—ã –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ 1–°</label>
    <input id="pubBase" placeholder="buh_demo_db" />
    
    <label>–§–∏–∑–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å</label>
    <input id="pubPath" placeholder="C:\inetpub\wwwroot\buh_demo" />
    
    <label>–°—Ç—Ä–æ–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–¥–ª—è webinst)</label>
    <input id="pubConn" placeholder="Srvr=&quot;localhost&quot;;Ref=&quot;buh_demo_db&quot;;" />
    
    <label>–í–µ—Ä—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</label>
    <select id="pubVersion"></select>

    <div style="margin-top: 15px; display: flex; gap: 10px;">
        <button onclick="sendPublish()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        <button class="secondary" onclick="document.getElementById('publishModal').close()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </dialog>

  <!-- Modal: Mass Update -->
  <dialog id="massUpdateModal" style="border: 1px solid #ccc; border-radius: 8px; padding: 20px; max-width: 500px;">
    <h3>–ú–∞—Å—Å–æ–≤–∞—è —Å–º–µ–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</h3>
    <p class="muted">–ù–∞–π–¥–µ—Ç –≤—Å–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ –∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç –Ω–∞ –Ω–æ–≤—É—é.</p>
    
    <label>–ò—Å—Ö–æ–¥–Ω–∞—è –≤–µ—Ä—Å–∏—è (–æ—Ç–∫—É–¥–∞)</label>
    <select id="massSource"></select>
    
    <label>–¶–µ–ª–µ–≤–∞—è –≤–µ—Ä—Å–∏—è (–∫—É–¥–∞)</label>
    <select id="massTarget"></select>

    <div style="margin-top: 15px; display: flex; gap: 10px;">
        <button onclick="sendMassUpdate()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
        <button class="secondary" onclick="document.getElementById('massUpdateModal').close()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </dialog>

<script>
  function apiKeyHeader() {
    const k = localStorage.getItem("x-api-key");
    return k ? { "X-Api-Key": k } : {};
  }

  async function loadSqlStatus() {
    const el = document.getElementById("sqlStatus");
    el.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    const res = await fetch("/api/setup/sql/status");
    const data = await res.json();
    el.textContent = data.isSet ? "SQL login: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" : "SQL login: –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω";
  }

  async function saveSqlLogin() {
    const msg = document.getElementById("sqlMsg");
    msg.textContent = "";
    const userId = document.getElementById("sqlUser").value;
    const password = document.getElementById("sqlPass").value;

    const res = await fetch("/api/setup/sql", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, password })
    });

    if (res.ok) {
      msg.textContent = "OK: SQL login —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –ï—Å–ª–∏ API/–∞–≥–µ–Ω—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω—ã ‚Äî –∏–º –º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è 10‚Äì20 —Å–µ–∫—É–Ω–¥ –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫.";
      msg.className = "muted ok";
      document.getElementById("sqlPass").value = "";
      await loadSqlStatus();
    } else {
      const t = await res.text();
      msg.textContent = "–û—à–∏–±–∫–∞: " + t;
      msg.className = "muted err";
    }
  }

  async function loadApiKeyStatus() {
    const el = document.getElementById("apiKeyStatus");
    el.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    const res = await fetch("/api/admin/apikey/status");
    const data = await res.json();
    el.textContent = data.isSet ? "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è)" : "–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω";
  }

  async function setApiKey() {
    const msg = document.getElementById("apiKeyMsg");
    msg.textContent = "";
    const apiKey = document.getElementById("apiKeyInput").value;

    const res = await fetch("/api/admin/apikey", {
      method: "POST",
      headers: { "Content-Type": "application/json", ...apiKeyHeader() },
      body: JSON.stringify({ apiKey })
    });

    if (res.ok) {
      localStorage.setItem("x-api-key", apiKey);
      msg.textContent = "OK: –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω—ë–Ω (–∏ –∑–∞–ø–∏—Å–∞–Ω –≤ localStorage –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤).";
      msg.className = "muted ok";
      await loadApiKeyStatus();
    } else {
      const t = await res.text();
      msg.textContent = "–û—à–∏–±–∫–∞: " + t;
      msg.className = "muted err";
    }
  }

  async function loadAgents() {
    const sel = document.getElementById("agentSelect");
    sel.innerHTML = "";
    const res = await fetch("/api/agents", { headers: apiKeyHeader() });
    const agents = await res.json();
    for (const a of agents) {
      const opt = document.createElement("option");
      opt.value = a.id;
      opt.textContent = `${a.name} (${a.hostname})`;
      sel.appendChild(opt);
    }
    if (agents.length > 0) await loadAgentSettings();
  }

  let currentAgentData = null;

  async function loadAgentSettings() {
    const agentId = document.getElementById("agentSelect").value;
    if (!agentId) return;
    const msg = document.getElementById("agentMsg");
    msg.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    const res = await fetch(`/api/agent/settings?agentId=${encodeURIComponent(agentId)}`, { headers: apiKeyHeader() });
    if (!res.ok) { msg.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"; msg.className="muted err"; return; }
    const s = await res.json();
    currentAgentData = s;

    document.getElementById("racPath").value = s.racPath || "";
    document.getElementById("rasHost").value = s.rasHost || "";
    document.getElementById("clusterUser").value = s.clusterUser || "";
    document.getElementById("pollInterval").value = s.pollIntervalSeconds || 30;
    document.getElementById("killMode").value = String(s.killModeEnabled);
    document.getElementById("agentEnabled").value = String(s.enabled);
    document.getElementById("clusterPass").value = "";
    document.getElementById("clusterPassSet").textContent = s.clusterPassIsSet ? "–ü–∞—Ä–æ–ª—å –∑–∞–¥–∞–Ω" : "–ü–∞—Ä–æ–ª—å –Ω–µ –∑–∞–¥–∞–Ω";

    // Versions
    const versions = s.installedVersionsJson ? JSON.parse(s.installedVersionsJson) : [];
    fillVersionSelect("defaultVersion", versions, s.defaultOneCVersion);
    fillVersionSelect("pubVersion", versions, s.defaultOneCVersion);
    fillVersionSelect("massSource", versions);
    fillVersionSelect("massTarget", versions, s.defaultOneCVersion);

    // Publications
    renderPublications(s.publications || []);

    msg.textContent = "";
    msg.className="muted";
  }
  
  function fillVersionSelect(id, versions, selected) {
    const sel = document.getElementById(id);
    sel.innerHTML = "<option value=''>-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>";
    for (const v of versions) {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        if (v === selected) opt.selected = true;
        sel.appendChild(opt);
    }
  }

  function onVersionChange() {
    const ver = document.getElementById("defaultVersion").value;
    if (ver) {
        // Auto-suggest rac path
        const path = `C:\\Program Files\\1cv8\\${ver}\\bin\\rac.exe`;
        document.getElementById("racPath").value = path;
    }
  }

  function renderPublications(pubs) {
    const tb = document.getElementById("pubsTable");
    tb.innerHTML = "";
    for (const p of pubs) {
        const tr = document.createElement("tr");
        tr.style.borderBottom = "1px solid #eee";
        tr.innerHTML = `
            <td style="padding: 8px;">${p.siteName}</td>
            <td style="padding: 8px;"><b>${p.appPath}</b></td>
            <td style="padding: 8px;" class="muted">${p.physicalPath}</td>
            <td style="padding: 8px;"><code>${p.version || "?"}</code></td>
            <td style="padding: 8px;">
                <button class="secondary" style="padding: 4px 8px; font-size: 12px;" onclick="promptUpdateVersion('${p.siteName}', '${p.appPath}', '${p.version}')">–°–º–µ–Ω–∏—Ç—å –≤–µ—Ä—Å–∏—é</button>
            </td>
        `;
        tb.appendChild(tr);
    }
    if (pubs.length === 0) {
        tb.innerHTML = "<tr><td colspan='5' style="padding:10px; text-align:center" class='muted'>–ù–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –±–∞–∑ (–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã)</td></tr>";
    }
  }

  async function saveAgentSettings() {
    const agentId = document.getElementById("agentSelect").value;
    const req = {
      enabled: document.getElementById("agentEnabled").value === "true",
      racPath: document.getElementById("racPath").value,
      rasHost: document.getElementById("rasHost").value,
      clusterUser: document.getElementById("clusterUser").value,
      clusterPass: document.getElementById("clusterPass").value,
      pollIntervalSeconds: parseInt(document.getElementById("pollInterval").value, 10),
      killModeEnabled: document.getElementById("killMode").value === "true",
      defaultOneCVersion: document.getElementById("defaultVersion").value
    };

    // Don't send empty password (means "keep as-is")
    if (!req.clusterPass) delete req.clusterPass;

    const msg = document.getElementById("agentMsg");
    msg.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
    msg.className="muted";

    const res = await fetch(`/api/agent/settings?agentId=${encodeURIComponent(agentId)}`, {
      method: "POST",
      headers: { "Content-Type": "application/json", ...apiKeyHeader() },
      body: JSON.stringify(req)
    });
    if (res.ok) {
      msg.textContent = "OK: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ.";
      msg.className="muted ok";
      await loadAgentSettings();
    } else {
      const t = await res.text();
      msg.textContent = "–û—à–∏–±–∫–∞: " + t;
      msg.className="muted err";
    }
  }

  async function sendCommand(type, payload) {
    const agentId = document.getElementById("agentSelect").value;
    if (!agentId) return;
    
    if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∞–≥–µ–Ω—Ç–∞.")) return;

    const res = await fetch(`/api/agents/${agentId}/commands`, {
        method: "POST",
        headers: { "Content-Type": "application/json", ...apiKeyHeader() },
        body: JSON.stringify({ type, payloadJson: JSON.stringify(payload) })
    });
    
    if (res.ok) {
        alert("–ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ø–∏—Å–æ–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–π —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.");
        loadAgentSettings(); // refresh
    } else {
        alert("–û—à–∏–±–∫–∞: " + await res.text());
    }
  }

  function showPublishModal() {
    document.getElementById("publishModal").showModal();
  }
  
  function sendPublish() {
    const payload = {
        BaseName: document.getElementById("pubName").value, // logic uses BaseName as AppName for webinst
        FolderPath: document.getElementById("pubPath").value,
        ConnectionString: document.getElementById("pubConn").value,
        Version: document.getElementById("pubVersion").value
    };
    if (!payload.BaseName || !payload.FolderPath || !payload.Version) {
        alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è"); return;
    }
    sendCommand("Publish", payload);
    document.getElementById("publishModal").close();
  }

  function showMassUpdateModal() {
    document.getElementById("massUpdateModal").showModal();
  }

  function sendMassUpdate() {
    const payload = {
        SourceVersion: document.getElementById("massSource").value,
        TargetVersion: document.getElementById("massTarget").value
    };
    if (!payload.SourceVersion || !payload.TargetVersion) { alert("–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏–∏"); return; }
    sendCommand("MassUpdateVersions", payload);
    document.getElementById("massUpdateModal").close();
  }

  function promptUpdateVersion(siteName, appPath, currentVer) {
    const newVer = prompt(`–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: ${currentVer}\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é:`, currentAgentData?.defaultOneCVersion || "");
    if (newVer && newVer !== currentVer) {
        const payload = {
            SiteName: siteName,
            AppPath: appPath,
            Version: newVer, // logic uses this to find bin path
            BaseName: appPath // used for matching in Update logic if needed, but logic uses Site+Path
        };
        // Reuse Publish command logic which handles "Exists" case as "Update"
        // Or better: use explicit UpdatePublicationVersion if supported, but Publish handles it.
        // Let's use Publish command which is smart enough.
        // Wait, Publish command expects FolderPath etc. 
        // My backend logic for Publish checks existing by Site+Path.
        // So I can send Publish with minimal info? No, it expects valid payload.
        // Let's use the explicit 'UpdatePublicationVersion' logic if I exposed it?
        // Ah, AgentCommandProcessor handles "UpdatePublicationVersion" with {SiteName, AppPath, NewVersionBinPath}.
        // But UI doesn't know BinPath.
        // Better to use "Publish" command with existing site/path, logic handles update.
        // But I need FolderPath etc?
        // Actually, my backend 'HandlePublishAsync' logic: 
        // if exists -> UpdatePublicationVersion(..., GetBinPath(p.Version)).
        // So I can send dummy FolderPath/ConnString if I know it exists.
        
        // Safer: Send "Publish" with correct Site/Name/Version. Dummy folder/conn string is fine because they are ignored if exists.
        sendCommand("Publish", {
            SiteName: siteName,
            BaseName: appPath,
            Version: newVer,
            FolderPath: "dummy", 
            ConnectionString: "dummy"
        });
    }
  }

  loadApiKeyStatus();
  loadSqlStatus();
  loadAgents();
</script>
</body>
</html>


